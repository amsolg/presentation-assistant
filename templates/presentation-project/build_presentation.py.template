#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
Script d'orchestration automatique - {PRESENTATION_SUBJECT} pour {AUDIENCE_NAME}
G√©n√©r√© automatiquement par le Presentation Assistant le {CREATION_DATE}

Ce script utilise les presentation_builder pour construire une pr√©sentation
adapt√©e sp√©cifiquement √† l'audience {AUDIENCE_NAME} selon l'analyse contextuelle.

Configuration audience:
- Niveau d'expertise: {EXPERTISE_LEVEL}
- Style Sam: {SAM_STYLE}
- Dur√©e cible: {TARGET_DURATION} minutes
- Scripts utilis√©s: {SCRIPTS_COUNT}

NOTES IMPORTANTES pour pr√©sentations compl√®tes:
- Les titres doivent faire moins de 45 caract√®res (limitation script 01)
- Script 01: Titre en argument positionnel (pas --title), utilise --subtitle, --metadata, --output
- Scripts 02-10: Tous n√©cessitent --insert-into et --template
- Chemins relatifs depuis presentation_builder/: ../presentations/[sujet]/[audience]/output/
- Template path: ../templates/Template_PT.pptx pour tous les scripts d'insertion
- S√©quence recommand√©e: 01‚Üí02‚Üí03/04‚Üí05/06‚Üí07/08/09‚Üí10 pour 8-12 slides
- Graphiques (script 09): N√©cessitent fichiers CSV dans dossier data/
"""

import os
import sys
import subprocess
import json
from datetime import datetime
from pathlib import Path

class PresentationOrchestrator:
    """Orchestrateur pour la construction automatique de pr√©sentation"""

    def __init__(self):
        self.project_root = Path(__file__).parent.parent.parent.parent
        self.presentation_builder_path = self.project_root / "presentation_builder"
        self.output_dir = Path(__file__).parent / "output"
        self.output_dir.mkdir(exist_ok=True)

        # Configuration sp√©cifique √† l'audience
        self.audience_config = {
            "audience": "{AUDIENCE_NAME}",
            "expertise_level": "{EXPERTISE_LEVEL}",
            "duration_target": "{TARGET_DURATION} minutes",
            "sam_style": "{SAM_STYLE}",
            "technical_depth": "{TECHNICAL_DEPTH}",
            "communication_style": "{COMMUNICATION_STYLE}"
        }

        # Informations du projet
        self.project_info = {
            "subject": "{PRESENTATION_SUBJECT}",
            "creation_date": "{CREATION_DATE}",
            "target_audience": "{AUDIENCE_NAME}",
            "estimated_slides": {ESTIMATED_SLIDES},
            "complexity_level": "{COMPLEXITY_LEVEL}"
        }

        # S√©quence de construction optimis√©e pour cette audience
        self.build_sequence = {BUILD_SEQUENCE_JSON}

        # Exemple de s√©quence compl√®te pour pr√©sentations 8-12 slides
        self.example_complete_sequence = [
            {
                "step_id": "title_slide",
                "script": "01_slide_title_creator.py",
                "params": ["{PRESENTATION_TITLE}", "--subtitle", "{PRESENTATION_SUBTITLE}", "--metadata", "{CREATION_DATE}", "--output", "../presentations/{PRESENTATION_SUBJECT}/{AUDIENCE_NAME}/output/{PRESENTATION_FILENAME}"],
                "description": "Cr√©ation de la slide de titre",
                "critical": True
            },
            {
                "step_id": "navigation",
                "script": "02_navigation_builder.py",
                "params": ["--insert-into", "../presentations/{PRESENTATION_SUBJECT}/{AUDIENCE_NAME}/output/{PRESENTATION_FILENAME}", "--template", "../templates/Template_PT.pptx", "--sections", "Introduction", "Analyse", "Solutions", "Impl√©mentation", "Conclusion"],
                "description": "Ajout de la navigation/table des mati√®res",
                "critical": True
            },
            {
                "step_id": "section_intro",
                "script": "03_section_header_builder.py",
                "params": ["--insert-into", "../presentations/{PRESENTATION_SUBJECT}/{AUDIENCE_NAME}/output/{PRESENTATION_FILENAME}", "--template", "../templates/Template_PT.pptx", "--title", "Introduction", "--style", "major"],
                "description": "En-t√™te section Introduction",
                "critical": False
            },
            {
                "step_id": "content_main",
                "script": "06_content_boxes_builder.py",
                "params": ["--insert-into", "../presentations/{PRESENTATION_SUBJECT}/{AUDIENCE_NAME}/output/{PRESENTATION_FILENAME}", "--template", "../templates/Template_PT.pptx", "--title", "Points Cl√©s", "--content", "Point 1", "Point 2", "Point 3"],
                "description": "Contenu principal avec bo√Ætes",
                "critical": True
            },
            {
                "step_id": "statistics",
                "script": "05_statistics_builder.py",
                "params": ["--insert-into", "../presentations/{PRESENTATION_SUBJECT}/{AUDIENCE_NAME}/output/{PRESENTATION_FILENAME}", "--template", "../templates/Template_PT.pptx", "--title", "Statistiques Cl√©s", "--stats", "75%:Satisfaction", "‚Ç¨2.5M:√âconomies"],
                "description": "Ajout de statistiques importantes",
                "critical": False
            },
            {
                "step_id": "charts",
                "script": "09_charts_builder.py",
                "params": ["--insert-into", "../presentations/{PRESENTATION_SUBJECT}/{AUDIENCE_NAME}/output/{PRESENTATION_FILENAME}", "--template", "../templates/Template_PT.pptx", "--title", "√âvolution des R√©sultats", "--style", "column_clustered", "--csv", "../presentations/{PRESENTATION_SUBJECT}/{AUDIENCE_NAME}/data/metrics.csv"],
                "description": "Graphiques avec donn√©es",
                "critical": False
            },
            {
                "step_id": "testimonial",
                "script": "08_testimonial_builder.py",
                "params": ["--insert-into", "../presentations/{PRESENTATION_SUBJECT}/{AUDIENCE_NAME}/output/{PRESENTATION_FILENAME}", "--template", "../templates/Template_PT.pptx", "--quote", "Cette solution a transform√© notre processus", "--author", "Client R√©f√©rence"],
                "description": "T√©moignage client",
                "critical": False
            },
            {
                "step_id": "conclusion",
                "script": "10_conclusion_builder.py",
                "params": ["--insert-into", "../presentations/{PRESENTATION_SUBJECT}/{AUDIENCE_NAME}/output/{PRESENTATION_FILENAME}", "--template", "../templates/Template_PT.pptx", "--title", "Prochaines √âtapes", "--cta", "Commen√ßons ensemble"],
                "description": "Slide de conclusion avec call-to-action",
                "critical": True
            }
        ]

    def log_step(self, step, message):
        """Log des √©tapes de construction"""
        timestamp = datetime.now().strftime("%H:%M:%S")
        print(f"[{timestamp}] √âTAPE {step}: {message}")

    def execute_script(self, script_name, params, description):
        """Ex√©cute un script presentation_builder avec gestion d'erreurs"""
        self.log_step("EXEC", f"Ex√©cution de {script_name} - {description}")

        script_path = self.presentation_builder_path / script_name
        cmd = [sys.executable, str(script_path)] + params

        try:
            result = subprocess.run(cmd,
                                  cwd=self.presentation_builder_path,
                                  capture_output=True,
                                  text=True,
                                  timeout=120)

            if result.returncode == 0:
                self.log_step("SUCCESS", f"{script_name} ex√©cut√© avec succ√®s")
                if result.stdout:
                    print(f"  Output: {result.stdout.strip()}")
                return True
            else:
                self.log_step("ERROR", f"√âchec de {script_name}")
                if result.stderr:
                    print(f"  STDERR: {result.stderr}")
                if result.stdout:
                    print(f"  STDOUT: {result.stdout}")
                return False

        except subprocess.TimeoutExpired:
            self.log_step("ERROR", f"Timeout lors de l'ex√©cution de {script_name}")
            return False
        except Exception as e:
            self.log_step("ERROR", f"Erreur inattendue avec {script_name}: {e}")
            return False

    def validate_environment(self):
        """Valide l'environnement avant construction"""
        self.log_step("VALIDATE", "Validation de l'environnement")

        # V√©rifier template Premier Tech
        template_path = self.project_root / "templates" / "Template_PT.pptx"
        if not template_path.exists():
            self.log_step("ERROR", f"Template Premier Tech non trouv√©: {template_path}")
            return False

        # Scripts presentation_builder disponibles (valid√©s depuis l'analyse)
        required_scripts = [
            "01_slide_title_creator.py",
            "02_navigation_builder.py",
            "03_section_header_builder.py",
            "04_simple_message_builder.py",
            "05_statistics_builder.py",
            "06_content_boxes_builder.py",
            "07_detailed_explanation_builder.py",
            "08_testimonial_builder.py",
            "09_charts_builder.py",
            "10_conclusion_builder.py"
        ]

        # Scripts requis pour cette pr√©sentation sp√©cifique
        scripts_for_this_presentation = {REQUIRED_SCRIPTS_LIST}

        # Valider tous les scripts disponibles
        for script in required_scripts:
            script_path = self.presentation_builder_path / script
            if not script_path.exists():
                self.log_step("ERROR", f"Script de base manquant: {script}")
                return False

        # Valider les scripts requis pour cette pr√©sentation
        for script in scripts_for_this_presentation:
            script_path = self.presentation_builder_path / script
            if not script_path.exists():
                self.log_step("ERROR", f"Script requis manquant: {script}")
                return False

        # V√©rifier la structure des donn√©es pour graphiques si n√©cessaire
        data_dir = Path(__file__).parent / "data"
        if any("09_charts_builder.py" in step.get("script", "") for step in self.build_sequence):
            if not data_dir.exists():
                self.log_step("WARNING", "Dossier data/ manquant - graphiques utiliseront donn√©es par d√©faut")

        self.log_step("SUCCESS", "Environnement valid√©")
        return True

    def validate_script_parameters(self):
        """Valide que les param√®tres des scripts sont corrects selon les tests analys√©s"""
        self.log_step("VALIDATE", "Validation des param√®tres de scripts")

        for step in self.build_sequence:
            script_name = step.get("script", "")
            params = step.get("params", [])

            # Validation sp√©cifique pour script 01 (titre creator)
            if script_name == "01_slide_title_creator.py":
                if "--title" in params:
                    self.log_step("WARNING", "Script 01: Utiliser titre en argument positionnel, pas --title")

            # Validation pour scripts 02-10 (insertion)
            elif script_name.startswith(("02_", "03_", "04_", "05_", "06_", "07_", "08_", "09_", "10_")):
                if "--insert-into" not in params:
                    self.log_step("WARNING", f"{script_name}: Param√®tre --insert-into requis")
                if "--template" not in params:
                    self.log_step("WARNING", f"{script_name}: Param√®tre --template requis")

        self.log_step("SUCCESS", "Param√®tres valid√©s")

    def build_presentation(self):
        """Construction s√©quentielle de la pr√©sentation"""
        self.log_step("START", "D√©but de la construction de pr√©sentation")

        # Validation de l'environnement
        if not self.validate_environment():
            return False

        # Variables de construction
        presentation_title = "{PRESENTATION_TITLE}"
        presentation_file = "{PRESENTATION_FILENAME}"
        presentation_path = self.output_dir / presentation_file

        # Validation des param√®tres sp√©cifiques aux scripts
        self.validate_script_parameters()

        steps_completed = []
        total_steps = len(self.build_sequence)

        # Construction s√©quentielle selon la s√©quence optimis√©e
        for step_num, step_config in enumerate(self.build_sequence, 1):
            self.log_step("PROGRESS", f"√âtape {step_num}/{total_steps}: {step_config['description']}")

            success = self.execute_script(
                step_config["script"],
                step_config["params"],
                step_config["description"]
            )

            if success:
                steps_completed.append(step_config["step_id"])
                self.log_step("STEP_SUCCESS", f"√âtape {step_num} termin√©e avec succ√®s")
            else:
                self.log_step("STEP_FAILED", f"√âchec de l'√©tape {step_num}")
                if step_config.get("critical", True):
                    self.log_step("ABORT", "√âtape critique √©chou√©e - arr√™t du processus")
                    return False

        # Validation finale de la pr√©sentation g√©n√©r√©e
        if presentation_path.exists():
            file_size = presentation_path.stat().st_size
            self.log_step("SUCCESS", f"Pr√©sentation cr√©√©e: {presentation_file} ({file_size:,} bytes)")
        else:
            self.log_step("ERROR", "Fichier de pr√©sentation non trouv√© apr√®s construction")
            return False

        # G√©n√©ration du rapport final
        self.generate_build_report(steps_completed, presentation_path)

        return True

    def generate_build_report(self, steps_completed, presentation_path):
        """G√©n√®re le rapport de construction"""
        report = {
            "presentation_info": self.project_info,
            "audience_config": self.audience_config,
            "build_timestamp": datetime.now().isoformat(),
            "steps_completed": steps_completed,
            "total_steps": len(self.build_sequence),
            "success_rate": len(steps_completed) / len(self.build_sequence) * 100,
            "output_file": str(presentation_path),
            "file_exists": presentation_path.exists(),
            "file_size_kb": presentation_path.stat().st_size // 1024 if presentation_path.exists() else 0,
            "build_sequence_used": self.build_sequence
        }

        # Sauvegarde du rapport
        report_path = self.output_dir / "build_report.json"
        with open(report_path, 'w', encoding='utf-8') as f:
            json.dump(report, f, indent=2, ensure_ascii=False)

        # Rapport d√©taill√© en markdown
        self.generate_detailed_report(report)

        self.log_step("REPORT", f"Rapport g√©n√©r√©: {report_path}")
        self.log_step("COMPLETE", f"Construction termin√©e - Pr√©sentation: {presentation_path}")

    def generate_detailed_report(self, report):
        """G√©n√®re un rapport d√©taill√© en markdown"""
        report_md = f"""# Rapport de Construction - {self.project_info['subject']}

## Informations G√©n√©rales

**Audience**: {self.audience_config['audience']}
**Date de construction**: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}
**Dur√©e cible**: {self.audience_config['duration_target']}
**Style Sam**: {self.audience_config['sam_style']}

## R√©sultats de Construction

**Statut**: {"‚úÖ Succ√®s complet" if report['success_rate'] == 100 else f"‚ö†Ô∏è Partiel ({report['success_rate']:.1f}%)"}
**Fichier g√©n√©r√©**: `{report['output_file']}`
**Taille**: {report['file_size_kb']:,} KB
**Slides estim√©es**: {self.project_info['estimated_slides']}

## √âtapes Ex√©cut√©es

"""
        for i, step in enumerate(self.build_sequence, 1):
            status = "‚úÖ" if step["step_id"] in report["steps_completed"] else "‚ùå"
            report_md += f"- {status} **√âtape {i}**: {step['description']} (`{step['script']}`)\n"

        report_md += f"""
## Configuration Sam AI

- **Style de communication**: {self.audience_config['communication_style']}
- **Profondeur technique**: {self.audience_config['technical_depth']}
- **Adaptation audience**: Optimis√©e pour {self.audience_config['audience']}

## Prochaines √âtapes

1. **R√©vision**: Examiner la pr√©sentation g√©n√©r√©e
2. **Ajustements**: Modifier ce script si n√©cessaire
3. **Narration**: Int√©grer avec Sam AI pour audio
4. **Distribution**: Pr√™t pour pr√©sentation

## Support Technique

- **Script source**: `build_presentation.py`
- **Logs d√©taill√©s**: Disponibles dans la console
- **Configuration**: Modifiable dans `__init__` de ce script

---

*G√©n√©r√© automatiquement par Presentation Assistant v2.5*
"""

        report_md_path = self.output_dir / "build_report.md"
        with open(report_md_path, 'w', encoding='utf-8') as f:
            f.write(report_md)

    def print_usage_help(self):
        """Affiche l'aide pour l'utilisation du template avec pr√©sentations compl√®tes"""
        help_text = f"""
AIDE POUR PR√âSENTATIONS COMPL√àTES
{"="*50}

Ce script g√©n√®re des pr√©sentations de 8-12 slides utilisant les templates Premier Tech.

S√âQUENCE EXEMPLE (8 slides):
1. Script 01: Slide titre                    ‚Üí Slide 1
2. Script 02: Navigation/table des mati√®res  ‚Üí Slide 2
3. Script 03: En-t√™te section               ‚Üí Slide 3
4. Script 06: Contenu principal (bo√Ætes)    ‚Üí Slide 4
5. Script 05: Statistiques cl√©s             ‚Üí Slide 5
6. Script 09: Graphiques avec donn√©es       ‚Üí Slide 6
7. Script 08: T√©moignage client             ‚Üí Slide 7
8. Script 10: Conclusion avec CTA           ‚Üí Slide 8

PARAM√àTRES CRITIQUES:
‚Ä¢ Script 01: python 01_slide_title_creator.py "Titre" --subtitle "Sous-titre"
‚Ä¢ Scripts 02-10: Tous n√©cessitent --insert-into fichier.pptx --template ../templates/Template_PT.pptx

DONN√âES REQUISES POUR GRAPHIQUES:
‚Ä¢ Cr√©er dossier data/ dans le m√™me r√©pertoire que ce script
‚Ä¢ Fichiers CSV avec colonnes: Cat√©gorie, Valeur (ou structures multi-s√©ries)

AUDIENCE: {self.audience_config['audience']}
EXPERTISE: {self.audience_config['expertise_level']}
STYLE SAM: {self.audience_config['sam_style']}

PERSONNALISATION:
1. Modifier self.build_sequence dans __init__()
2. Adapter les param√®tres selon votre contenu
3. Utiliser self.example_complete_sequence comme base

EXEMPLE D'UTILISATION:
python build_presentation.py
        """
        print(help_text)

def main():
    """Point d'entr√©e principal"""
    import argparse

    parser = argparse.ArgumentParser(description="Orchestrateur de pr√©sentation compl√®te")
    parser.add_argument("--help-complete", action="store_true",
                       help="Afficher l'aide d√©taill√©e pour pr√©sentations compl√®tes")
    args = parser.parse_args()

    print("=" * 60)
    print(f"ORCHESTRATEUR DE PR√âSENTATION")
    print(f"Sujet: {PRESENTATION_SUBJECT}")
    print(f"Audience: {AUDIENCE_NAME}")
    print(f"G√©n√©r√© le: {CREATION_DATE}")
    print("=" * 60)

    orchestrator = PresentationOrchestrator()

    if args.help_complete:
        orchestrator.print_usage_help()
        return

    success = orchestrator.build_presentation()

    if success:
        print("\n" + "=" * 60)
        print("üéâ SUCC√àS: Pr√©sentation construite avec succ√®s!")
        print("üìÅ Fichiers g√©n√©r√©s dans le dossier 'output/'")
        print("ü§ñ Pr√™t pour la narration Sam AI")
        print("üìã Consultez build_report.md pour les d√©tails")
        print("=" * 60)
    else:
        print("\n" + "=" * 60)
        print("‚ùå √âCHEC: Erreurs lors de la construction")
        print("üìã Consultez les logs ci-dessus pour diagnostiquer")
        print("üîß Modifiez la configuration si n√©cessaire")
        print("=" * 60)
        sys.exit(1)

if __name__ == "__main__":
    main()